namespace = opportunityManager

## Can be called at any point during the progress tracker, will check for opporunity
## Can put player back into the tracker when done
## Can also reset the tracket etc.
## Rolls for type of opportunity

## Can be called when running any type of operation

## When opporunity chosen, sends over to relevant opporunity file.

## Adding new events should be as easy as adding them to a role table

## NEED TO BE ABLE TO HANDLE BOTH ALPHA AND BETA, ALL IN ONE










## AB GENRIC FLAG/TARGET GEN ##
country_event = {
	id = opportunityManager.0
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		save_event_target_as = spyOpportunityAttacker
		if = {
			limit = {
				is_same_value = event_target:spyOpportunityAttacker_BetaNetwork
			}
			event_target:betaNetworkTarget_temp = {
				save_event_target_as = spyOpportunityTarget
			}
		}
		else = {
			event_target:alphaNetworkTarget_temp = {
				save_event_target_as = spyOpportunityTarget
			}
		}
	} 
}


## OPPORTUNITY INDEX - SENDS OUT TO INDIIVUAL OPPORTUNITY CATEGORY ROLL TABLES ##
country_event = {
	id = opportunityManager.1
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		# CHECK IF RUNNING SABREP OP
		if = {
			limit = {
				or = {
					has_country_flag = saboRep
					has_country_flag = saboRep2
				}
			}
			country_event = {
				id = opportunityManager.10
			}
		}
		else_if = {
			limit = {
				or = {
					has_country_flag = studyTech
					has_country_flag = studyTech2
				}
			}
			country_event = {
				id = opportunityManager.11
			}
		}
		else_if = {
			limit = {
				or = {
					has_country_flag = fundCrime
					has_country_flag = fundCrime2
				}
			}
			country_event = {
				id = opportunityManager.12
			}
		}
		else_if = {
			limit = {
				or = {
					has_country_flag = swingEthics
					has_country_flag = swingEthics2
				}
			}
			country_event = {
				id = opportunityManager.13
			}
		}
		else_if = {
			limit = {
				or = {
					has_country_flag = sowUnrest
					has_country_flag = sowUnrest2
				}
			}
			country_event = {
				id = opportunityManager.14
			}
		}
	}
}


#EVENT ENDERS = {
	#1 - SEND BACK TO START OF PROGRESS CHAIN
	#2 - SEND TO END OF PROGRESS CHAIN - SUCCESS
	#3 - SEND TO END OF PROGRESS CHAIN - FAIL
	#4 - SEND BACK INTO PROGRESS CHAIN
#}
## ENDS THE OPPORTUNITY EVENT ##
country_event = {
	id = opportunityManager.3
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		set_country_flag = opportunityEnd_1
		set_country_flag = opportunityEnd_2
		set_country_flag = opportunityEnd_3
		set_country_flag = opportunityEnd_4

		if = { # SEND BACK TO START OF PROGRESS CHAIN
			limit = {
				has_country_flag = opportunityEnd_1
			}
			remove_country_flag = opportunityEnd_1
			if = { #is beta
				limit = {
					is_same_value = event_target:spyOpportunityAttacker_BetaNetwork
				}
				country_event = { id = progressTrackerB.1 }
			}
			else = { #is alpha
				country_event = { id = progressTrackerA.1 }
			}
		}

		else_if = { # SEND TO END OF PROGRESS CHAIN - SUCCESS
			limit = {
				has_country_flag = opportunityEnd_2
			}
			remove_country_flag = opportunityEnd_2
			if = { #is beta
				limit = {
					is_same_value = event_target:spyOpportunityAttacker_BetaNetwork
				}
				country_event = { id = progressTrackerB.9 }
			}
			else = { #is alpha
				country_event = { id = progressTrackerA.9 }
			}
		}

		else_if = { # SEND TO END OF PROGRESS CHAIN - FAIL
			limit = {
				has_country_flag = opportunityEnd_3
			}
			remove_country_flag = opportunityEnd_3
			if = { #is beta
				limit = {
					is_same_value = event_target:spyOpportunityAttacker_BetaNetwork
				}
				set_country_flag = failedBeta country_event = { id = spyFailEvt.0 }
			}
			else = { #is alpha
				country_event = { id = spyFailEvt.0 }
			}
		}

		else_if = { # SEND BACK INTO PROGRESS CHAIN
			limit = {
				has_country_flag = opportunityEnd_4
			}
			remove_country_flag = opportunityEnd_4
			if = { #is beta
				limit = {
					is_same_value = event_target:spyOpportunityAttacker_BetaNetwork
				}
				set_country_flag = gatherProgress_3_2
				country_event = { id = progressTrackerB.4 } 
			}
			else = { #is alpha
				set_country_flag = gatherProgress_3
				country_event = { id = progressTrackerA.4 } 
			}
		}
	}
}

















#### ROLL TABLES #####
## SABOREP OPPORTUNITY EVENT ROLL TABLE ##
country_event = {
	id = opportunityManager.10
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		set_timed_country_flag = { flag = opportunityCooldown days = 3650 }
		set_country_flag = betaF_OpportunityOngoing
		set_country_flag = alphaF_OpportunityOngoing
		random_list = {
			50 = {}
			50 = {}
		}
	}
}

## STUDY TECH OPPORTUNITY EVENT ROLL TABLE ##
country_event = {
	id = opportunityManager.11
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		random_list = {
			50 = {}
			50 = {}
		}
	}
}

## FUND CRIME OPPORTUNITY EVENT ROLL TABLE ##
country_event = {
	id = opportunityManager.12
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		random_list = {
			50 = {}
			50 = {}
		}
	}
}


## SWING ETHICS OPPORTUNITY EVENT ROLL TABLE ##
country_event = {
	id = opportunityManager.13
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		random_list = {
			50 = {}
			50 = {}
		}
	}
}

## SOW UNREST OPPORTUNITY EVENT ROLL TABLE ##
country_event = {
	id = opportunityManager.14
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		random_list = {
			50 = {}
			50 = {}
		}
	}
}




























### IF FAIL OR DECLINE OR SUCCEED, PUT THEM BACK INTO PROGRESS TRACKER ###
country_event = {
	id = spyOpportunity.0
	hide_window = yes
	is_triggered_only = yes 
	
	immediate = {
		if = {
			limit = {
				has_country_flag = betaF_Opportunity
			}
			remove_country_flag = betaF_Opportunity
			remove_country_flag = betaF_OpportunityOngoing
			country_event = { id = progressTrackerB.3 }
		}
		else = {
			remove_country_flag = alphaF_OpportunityOngoing
			country_event = { id = progressTrackerA.3 }
		}
	}
} 
### GIVE OPPORTUNITY FLAGS, ROLL FOR EVENT ###
country_event = {
	id = spyOpportunity.1
	hide_window = yes
	is_triggered_only = yes 
	
	immediate = {
		set_timed_country_flag = { flag = opportunityLock days = 3650 }
		save_event_target_as = spyOpportunityAttacker
		if = {
			limit = {
				has_country_flag = betaF_Opportunity
			}
			event_target:betaNetworkTarget_temp = { save_event_target_as = spyOpportunityTarget }
			set_country_flag = betaF_OpportunityOngoing
		}
		else = {
			event_target:alphaNetworkTarget_temp = { save_event_target_as = spyOpportunityTarget }
			set_country_flag = alphaF_OpportunityOngoing
		}

		random_list = {
			50 = { # DEFECTING SCIENTIST
				modifier = {
					factor = 0
					or = {
						event_target:spyOpportunityTarget = { 
							is_ai = no 
						}
						has_country_flag = OppdefectingScientistCooldown
					}
				}
				set_timed_country_flag = {
					flag = OppdefectingScientistCooldown
					days = 3650
				}
				country_event = { id = studyTech_Opportunity.3 }
			}
			50 = { # INFECTED AGENTS
				modifier = {
					factor = 0
					or = {
						has_country_flag = OppinfectedAgents
						event_target:spyOpportunityTarget = {
							is_at_war_with = event_target:spyOpportunityAttacker
						}
						event_target:spyOpportunityTarget = {
							nor = {
								has_technology = tech_genome_mapping
								has_technology = tech_vitality_boosters
								has_technology = tech_frontier_hospital
								has_technology = tech_alien_life_studies
								has_technology = tech_society_3
								has_technology = tech_society_2
								has_technology = tech_society_1
							}
						}
					}
				}
				set_timed_country_flag = {
					flag = OppinfectedAgents
					days = 3650
				}
				country_event = { id = studyTech_Opportunity.1 }
			}
			10 = {
				country_event = {
					id = spyOpportunity.0
				}
			}
		}
	}
}
